---
title: 概览
excerpt: null
last_modified_at: '2020-08-09'
toc: true
tags:
- Java
- Spring
- Spring Security
---

Spring Security对Servlet的支持基于Servlet的Filter。

![]({{ 'assets/image/spring-security/delegatingfilterproxy.png' | relative_url }})

# Filter

当客户端请求应用时，容器就会创建一个`FilterChain`， 其中包含多个`Filter`。`Filter`的作用：

* 阻止下游`Filter`, 或使`Servlet`被开始调用
* 修改`HttpServletRequest` `HttpServletResponse` 传递给下游`Filter`或者`Servlet`。

FilterChain使用示例：
```
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {
    // do something before the rest of the application
    chain.doFilter(request, response); // invoke the rest of the application
    // do something after the rest of the application
}
```

# Servlet

`Servlet` (Server Applet)，是用Java编写的服务端程序，广义上是指实现了`Servlet`接口的类。在Spring MVC应用中，其实现是`DispatcherServlet`，用于处理`HttpServletRequest`、`HttpServletResponse`

# DelegatingFilterProxy

Spring提供了`Filter`的实现`DelegatingFilterProxy`，用来桥接Servlet容器的生命周期和Spring的`ApplicationContext`。`DelegatingFilterProxy`使用标准的Servlet容器注册机制进行注册，然后委托给继承`Filter`的Spring Bean（图中 Bean Filter）。

`DelegatingFilterProxy`实现的伪代码：
```
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {
    // Lazily get Filter that was registered as a Spring Bean
    // For the example in DelegatingFilterProxy delegate is an instance of Bean Filter0
    Filter delegate = getFilterBean(someBeanName);
    // delegate work to the Spring Bean
    delegate.doFilter(request, response);
}
```

自动配置: `SecurityFilterAutoConfiguration.securityFilterChainRegistration`
```
@Bean
@ConditionalOnBean(name = DEFAULT_FILTER_NAME)
public DelegatingFilterProxyRegistrationBean securityFilterChainRegistration(
		SecurityProperties securityProperties) {
	DelegatingFilterProxyRegistrationBean registration = new DelegatingFilterProxyRegistrationBean(
		    DEFAULT_FILTER_NAME);
	registration.setOrder(securityProperties.getFilter().getOrder());
	registration.setDispatcherTypes(getDispatcherTypes(securityProperties));
	return registration;
}
```

# FilterChainProxy

`FilterChainProxy` Spring Security提供一个特殊的`Filter`，通过`SecurityFilterChain`委托给其它`Filter`实例。它通常被包装在`DelegatingFilterProxy`。

自动配置：spring-security-config的Jar包下`spring.handlers`:
````
http\://www.springframework.org/schema/security=org.springframework.security.config.SecurityNamespaceHandler
````

`SecurityNamespaceHandler`:
```
this.parsers.put("http", new HttpSecurityBeanDefinitionParser());
```

`HttpSecurityBeanDefinitionParser`:
```
static void registerFilterChainProxyIfNecessary(ParserContext pc, Object source) {
        if (!pc.getRegistry().containsBeanDefinition("org.springframework.security.filterChainProxy")) {
            ...
            // 注册别名：springSecurityFilterChain，就是上文中的 DEFAULT_FILTER_NAME
            pc.getRegistry().registerAlias("org.springframework.security.filterChainProxy", "springSecurityFilterChain");
        }
    }
```

# SecurityFilterChain
![]({{ 'assets/image/spring-security/securityfilterchain.png' | relative_url }})
