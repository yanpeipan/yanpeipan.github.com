

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>高可用 &larr; </title>
  <meta name="author" content="Yan Peipan" />
  <link rel="start" href="/" />
  
  
  
  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/assets/themes/mark-reid/css/syntax.css" type="text/css" />
  <!-- Homepage CSS -->
  <link rel="stylesheet" href="/assets/themes/mark-reid/css/screen.css" type="text/css" />
</head>
<body id="">
  <div id="site">
    <div id="header">
      <h1>
        <a href="/" title="Yan">Yan</a>
        <span class="byline">&larr; <a href="/">Yan Peipan</a></span>
      </h1>
      <ul class="nav">
        <li><a href="/" class="home">Home</a></li>
        <li><a href="/archive.html">Archive</a></li>
        <li><a href="/pages.html">Pages</a></li>
        <li><a href="/categories.html">Categories</a></li>
        <li><a href="/tags.html">Tags</a></li>
      </ul>
    </div>
    

<div id="page">
  <h1 class="emphnext">高可用</h1>
  <ul class="tag_box inline">
    
    

  
    
    	<li><a href="/tags.html#高可用-ref">高可用 <span>2</span></a></li>
    
  



  </ul>
  
<ul>
  <li><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8">高可用</a></li>
  <li><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E5%BA%A6%E9%87%8F">高可用的定义和度量</a>
    <ul>
      <li><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9A%E4%B9%89">高可用定义</a></li>
      <li><a href="#%E5%8F%AF%E7%94%A8%E6%80%A77%E7%BA%A7%E5%9B%BE%E8%A1%A8">可用性7级图表</a></li>
      <li><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%BA%A6%E9%87%8F">高可用度量</a>
        <ul>
          <li><a href="#ptopro">PTO/PRO</a></li>
          <li><a href="#%E8%AF%B7%E6%B1%82%E6%88%90%E5%8A%9F%E7%8E%87">请求成功率</a></li>
          <li><a href="#sliservice-level-indicator-%E6%9C%8D%E5%8A%A1%E7%AD%89%E7%BA%A7%E6%8C%87%E6%A0%87">SLI(Service Level Indicator 服务等级指标)</a></li>
          <li><a href="#sloservice-level-objective-%E6%9C%8D%E5%8A%A1%E7%AD%89%E7%BA%A7%E7%9B%AE%E6%A0%87">SLO(Service level objective 服务等级目标)</a></li>
          <li><a href="#sla">SLA</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">高可用解决方案</a>
    <ul>
      <li><a href="#master-slave">Master-Slave</a></li>
      <li><a href="#master-master">Master-Master</a></li>
      <li><a href="#twothree-phase-commit2pc-%E4%B8%A4%E6%AE%B5%E6%8F%90%E4%BA%A4">Two/Three Phase Commit(2PC 两段提交)</a></li>
      <li><a href="#paxos%E7%AE%97%E6%B3%95">Paxos算法</a></li>
    </ul>
  </li>
  <li><a href="#%E5%BD%B1%E5%93%8D%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E5%9B%A0%E7%B4%A0">影响高可用的因素</a></li>
</ul>

<h1 id="高可用">高可用</h1>
<p>高可用，英文叫High Availability（Wikipedia词条），基本上来说，就是要让我们的计算环境（包括软硬件）做到full-time的可用性。在设计上一般来说，需要做好如下的设计：</p>

<ul>
  <li>对软硬件的冗余，以消除单点故障。任何系统都会有一个或多个冗余系统做standby</li>
  <li>对故障的检测和恢复。检测故障以及用备份的结点接管故障点。这也就是failover</li>
  <li>需要很可靠的交汇点（CrossOver）。这是一些不容易冗余的结点，比如域名解析，负载均衡器等。</li>
</ul>

<p>细节之处全是魔鬼，冗余结点最大的难题就是<strong>对于有状态的结点的数据复制和数据一致性的保证</strong>（无状态结点的冗余相对比较简单）。冗余数据所带来的一致性问题是魔鬼中的魔鬼：</p>

<ul>
  <li>如果系统的数据镜像到冗余结点是异步的，那么在failover的时候就会出现数据差异的情况。</li>
  <li>如果系统在数据镜像到冗余结点是同步的，那么就会导致冗余结点越多性能越慢。</li>
</ul>

<h1 id="高可用的定义和度量">高可用的定义和度量</h1>

<h2 id="高可用定义">高可用定义</h2>

<ul>
  <li>可用性（availability）是关于系统可供使用时间的表述，以不可用的时间为衡量指标。不可用时间越短，可用性越高。通常用 n 个 9 来描述。</li>
  <li>可靠性（reliability）是关于系统无故障时间间隔的描述，以发生故障的次数为衡量指标，故障次数越少，可靠性越高。</li>
  <li>可维护性（maintainability）是指系统发生故障后，恢复的时间来描述。时间越短，可维护性越高。</li>
</ul>

<h2 id="可用性7级图表">可用性7级图表</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: center">level</th>
      <th style="text-align: left">description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: left">Crash with data corruption, destruction. 崩溃造成数据丢失</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: left">Crash with new data loss. 崩溃造成新数据丢失</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: left">Crash without data loss. 崩溃不会造成数据丢失或损坏</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: left">No crash, but with no or very limited service, low service quality. 通过有限制的服务防止崩溃和低质量</td>
    </tr>
    <tr>
      <td style="text-align: center">5</td>
      <td style="text-align: left">Partial or limited service, with good to medium service quality. 部分或者限制级服务具有很好的媒介质量</td>
    </tr>
    <tr>
      <td style="text-align: center">6</td>
      <td style="text-align: left">Failover with significant user visible delay, near full quality of service. 对显著延迟故障转移提供全质量服务</td>
    </tr>
    <tr>
      <td style="text-align: center">7</td>
      <td style="text-align: left">Failover with minimal to none user visible delay, near full qualityof service. 对最小延迟故障转移提供全质量服务</td>
    </tr>
  </tbody>
</table>

<h2 id="高可用度量">高可用度量</h2>

<h3 id="ptopro">PTO/PRO</h3>

<p>RTO和RPO是传统数据库领域常见的两个衡量高可用的指标。</p>

<ul>
  <li>RTO(Recovery time objective):故障恢复耗时</li>
  <li>RPO(Recovery point objective):恢复后数据对应的时间点，即丢失的数据量转换为时间</li>
</ul>

<h3 id="请求成功率">请求成功率</h3>

<p>可用性=成功请求数/总请求数</p>

<h3 id="sliservice-level-indicator-服务等级指标">SLI(Service Level Indicator 服务等级指标)</h3>
<p>SLI是经过仔细定义的测量指标，常见测量指标：</p>

<ul>
  <li>性能
    <ul>
      <li>响应时间(latency)</li>
      <li>吞吐量(throughput)</li>
      <li>请求量(qps)</li>
      <li>实效性(freshness)</li>
    </ul>
  </li>
  <li>可用性
    <ul>
      <li>运行时间(uptime)</li>
      <li>故障时间/频率</li>
      <li>可靠性</li>
    </ul>
  </li>
  <li>质量
    <ul>
      <li>准确性(accuracy)</li>
      <li>正确性(correctness)</li>
      <li>完整性(completeness)</li>
      <li>覆盖率(coverage)</li>
      <li>相关性(relevance)</li>
    </ul>
  </li>
  <li>内部指标
    <ul>
      <li>队列长度(queue length)</li>
      <li>内存占用(RAM usage)</li>
    </ul>
  </li>
  <li>因素人
    <ul>
      <li>响应时间(time to response)</li>
      <li>修复时间(time to fix)</li>
      <li>修复率(fraction fixed)</li>
    </ul>
  </li>
</ul>

<h3 id="sloservice-level-objective-服务等级目标">SLO(Service level objective 服务等级目标)</h3>

<p>指定服务所提供功能的一种期望状态，SLO是用SLI来描述的，如:每分钟平均qps &gt; 100k/s、99% 访问延迟 &lt; 500ms。</p>

<h3 id="sla">SLA</h3>

<p>服务级别协议（service-level agreement，缩写SLA）也称服务等级协议、服务水平协议，用于在商业上定义系统的高可用。SLA = SLO + 后果</p>

<p><img src="/assets/image/sla.webp" alt="" /></p>

<p>Percent of Uptime(平均服务时间)</p>

<ul>
  <li>MTBF(Mean time between Failures): 平均故障间隔</li>
  <li>MTTR(Mean time to recover): 平均修复时间</li>
  <li>MTTF (Mean Time To Failure): 平均故障时间</li>
</ul>

<p><code>Availability = MTBF / (MTBF + MTTR)</code></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"> </th>
      <th style="text-align: center">可用性</th>
      <th style="text-align: center">数据持久度</th>
      <th>除外条款</th>
      <th>赔偿条款</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">阿里云ECS</td>
      <td style="text-align: center">99.95%</td>
      <td style="text-align: center">99.9999999%</td>
      <td>（1）不可使用的服务时间低于5分钟的，不计入不可用时间；（2）阿里云预先通知用户后进行系统维护所引起的，包括割接、维修、升级和模拟故障演练；</td>
      <td>（3）不可抗力以及意外事件引起的；	不可用时间100倍</td>
    </tr>
    <tr>
      <td style="text-align: center">阿里云rds</td>
      <td style="text-align: center">99.95%</td>
      <td style="text-align: center"> </td>
      <td>同上，高可用版和金融版为1分钟	不可用时间100倍，高可用版和金融版，服务费的15% - 30% - 100% （99.95%-99%-95%）</td>
      <td> </td>
    </tr>
    <tr>
      <td style="text-align: center">AWS EC2</td>
      <td style="text-align: center">99.95%</td>
      <td style="text-align: center"> </td>
      <td>无活跃链接，运维不算，不可抗力不算</td>
      <td>低于99.95%，赔 10%；低于99%，赔30%</td>
    </tr>
    <tr>
      <td style="text-align: center">AWS RDS</td>
      <td style="text-align: center">99.95%</td>
      <td style="text-align: center"> </td>
      <td>类似阿里，不计时间为1分钟</td>
      <td>低于99.95%，赔 10%；低于99%，赔25%</td>
    </tr>
    <tr>
      <td style="text-align: center">AWS S3</td>
      <td style="text-align: center">99.99%</td>
      <td style="text-align: center">99.999999999%</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td style="text-align: center">腾讯云云主机</td>
      <td style="text-align: center">99.95%</td>
      <td style="text-align: center">99.999%</td>
      <td>5分钟以下不计费，无其他除外条款</td>
      <td>不可用时间100倍</td>
    </tr>
  </tbody>
</table>

<h1 id="高可用解决方案">高可用解决方案</h1>
<p><img src="/assets/image/Transaction-Across-DataCenter.jpg" alt="" /></p>

<p>Google App Engine的co-founder Ryan Barrett在2009年的Google I/O上的演讲《Transaction Across DataCenter》（视频： http://www.youtube.com/watch?v=srOgpXECblk）</p>

<p>主要考虑以下几个问题：</p>

<ul>
  <li>容灾：数据不丢、结点的故障转移Failover</li>
  <li>数据的一致性：事务处理</li>
  <li>性能：吞吐量 、 响应时间</li>
</ul>

<h2 id="master-slave">Master-Slave</h2>
<h2 id="master-master">Master-Master</h2>
<h2 id="twothree-phase-commit2pc-两段提交">Two/Three Phase Commit(2PC 两段提交)</h2>
<h2 id="paxos算法">Paxos算法</h2>

<h1 id="影响高可用的因素">影响高可用的因素</h1>

<p>无计划的</p>

<ul>
  <li>系统级的故障 –  包括主机、操作系统、中间件、数据库、网络、电源以及外围设备</li>
  <li>数据和中介的故障 – 包括人员误操作、硬盘故障、数据乱了</li>
  <li>还有：自然灾害、人为破坏、以及供电问题。</li>
</ul>

<p>有计划的</p>

<ul>
  <li>日常任务：备份，容量规划，用户和安全管理，后台批处理应用</li>
  <li>运维相关：数据库维护、应用维护、中间件维护、操作系统维护、网络维护</li>
  <li>升级相关：数据库、应用、中间件、操作系统、网络、包括硬件升级</li>
</ul>

<p>真正决定高可用系统的本质原因</p>

<ul>
  <li>一套科学的牛逼的软件工程的管理</li>
  <li>先进的自动化的运维工具</li>
  <li>技术能力很牛逼的工程师团队</li>
</ul>

<hr />
<ul>
  <li><a href="https://coolshell.cn/articles/17459.html">酷壳-关于高可用的系统</a></li>
  <li><a href="https://coolshell.cn/articles/10910.html">酷壳-分布式系统的事务处理</a></li>
  <li><a href="https://www.jianshu.com/p/7ca6bc59d6b3">数据库高可用的定义和度量</a></li>
  <li><a href="https://blog.coding.net/blog/architecture-concept-and-practice-from-Google">来自 Google 的高可用架构理念与实践</a></li>
  <li><a href="http://www.yunweipai.com/archives/10703.html">深度剖析什么是 SLI、SLO和SLA</a></li>
</ul>

  <address class="signature">
    <a class="author" href="/">Yan Peipan</a>
    <span class="date">19 September 2018</span>
    <span class="location"></span>
  </address>
  <div class="prev-next">
    
    <a href="/php/2018/10/31/xdebug%E5%8D%8F%E5%8A%A9%E8%B0%83%E8%AF%95%E4%B8%8E%E5%BC%80%E5%8F%91.html" class="next" title="Xdebug: 协助调试与开发">Next Post &rarr;</a>
    
    
    <a href="/2018/09/13/io.html" class="prev" title="网络I/O模型">&larr; Earlier Post</a>
    
  </div>
</div><!-- End Page -->




    <div id="footer">
      <address>
        <span class="copyright">
          Content by <a href="/sitemap.txt">Yan Peipan</a>.
        </span>
        <span class="engine">
          Powered by <a href="http://github.com/mojombo/jekyll/" title="A static, minimalist CMS">Jekyll</a>
        </span>
      </address>
    </div>
  </div>
  <!--[if IE 6]>
  <script type="text/javascript">
  /*Load jQuery if not already loaded*/ if(typeof jQuery == 'undefined'){ document.write("<script type=\"text/javascript\"   src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js\"></"+"script>"); var __noconflict = true; }
  var IE6UPDATE_OPTIONS = {
  icons_path: "http://static.ie6update.com/hosted/ie6update/images/"
}
</script>
<script type="text/javascript" src="http://static.ie6update.com/hosted/ie6update/ie6update.js"></script>
<![endif]-->


</body>
</html>

