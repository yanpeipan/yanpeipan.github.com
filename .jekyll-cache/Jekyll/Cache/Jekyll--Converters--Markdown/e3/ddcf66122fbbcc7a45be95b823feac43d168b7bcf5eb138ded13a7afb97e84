I"–
<hr />

<h1 id="ä¸€ä¸ªé€šç”¨é—®é¢˜">ä¸€ä¸ªé€šç”¨é—®é¢˜</h1>

<p>å¦‚ä½•æŸ¥æ‰¾æ‰€æœ‰é¢‘é“æ­£åœ¨æ’­å‡ºçš„èŠ‚ç›®ï¼Ÿ å¦‚ä½•æŸ¥æ‰¾æ‰€æœ‰åˆ†ç±»ä¸‹æœ€çƒ­é—¨çš„å†…å®¹ï¼Ÿ å¦‚ä½•æŸ¥æ‰¾æ‰€æœ‰è¿åŠ¨å‘˜çš„æœ€å¥½æˆç»©ï¼Ÿ<br />
è¿™äº›é—®é¢˜éƒ½å¯ä»¥æŠ½è±¡ä¸ºï¼šå¦‚ä½•å–åˆ†ç»„çš„æœ€å€¼ï¼Ÿ</p>

<hr />

<h1 id="sql">SQL</h1>

<p>æ•°æ®åº“ï¼šMySQL</p>

<h2 id="åŸºäºsqlçš„å‡ ç§å®ç°">åŸºäºSQLçš„å‡ ç§å®ç°</h2>

<p>ä»»åŠ¡ï¼šä¸ºæ¯ä»¶ç‰©å“æ‰¾åˆ°æ ‡ä»·æœ€é«˜çš„ç»é”€å•†</p>

<h3 id="å…³è”å­æŸ¥è¯¢">å…³è”å­æŸ¥è¯¢</h3>

<p>æœ€å¥½ç†è§£ï¼Œ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”è¯¥é¿å…å­æŸ¥è¯¢ï¼Œæ•ˆç‡éå¸¸ä½ã€‚</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>SELECT article, dealer, price
FROM   shop s1
WHERE  price=(SELECT MAX(s2.price)
              FROM shop s2
              WHERE s1.article = s2.article);
</pre></div>
</div>
</div>

<h3 id="éå…³è”å­æŸ¥è¯¢">éå…³è”å­æŸ¥è¯¢</h3>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>SELECT s1.article, dealer, s1.price
FROM shop s1
JOIN (
  SELECT article, MAX(price) AS price
  FROM shop
  GROUP BY article) AS s2
  ON s1.article = s2.article AND s1.price = s2.price;
</pre></div>
</div>
</div>

<h3 id="å·¦å…³è”">å·¦å…³è”</h3>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>SELECT s1.article, s1.dealer, s1.price
FROM shop s1
LEFT JOIN shop s2 ON s1.article = s2.article AND s1.price &lt; s2.price
WHERE s2.article IS NULL;
</pre></div>
</div>
</div>

<hr />

<h2 id="åè¯è§£é‡Š">åè¯è§£é‡Š</h2>

<ul>
  <li>
    <p>B+æ ‘
B+æ ‘æ˜¯ä¸€ç§ç»å…¸çš„æ•°æ®ç»“æ„ï¼Œç”±å¹³è¡¡æ ‘å’ŒäºŒå‰æŸ¥æ‰¾æ ‘ç»“åˆäº§ç”Ÿï¼Œå®ƒæ˜¯ä¸ºç£ç›˜æˆ–å…¶å®ƒç›´æ¥å­˜å–è¾…åŠ©è®¾å¤‡è€Œè®¾è®¡çš„ä¸€ç§å¹³è¡¡æŸ¥æ‰¾æ ‘ï¼Œåœ¨B+æ ‘ä¸­ï¼Œæ‰€æœ‰çš„è®°å½•èŠ‚ç‚¹éƒ½æ˜¯æŒ‰é”®å€¼å¤§å°é¡ºåºå­˜æ”¾åœ¨åŒä¸€å±‚çš„å¶èŠ‚ç‚¹ä¸­ï¼Œå¶èŠ‚ç‚¹é—´ç”¨æŒ‡é’ˆç›¸è¿ï¼Œæ„æˆåŒå‘å¾ªç¯é“¾è¡¨ï¼Œéå¶èŠ‚ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹ã€æèŠ‚ç‚¹ï¼‰åªå­˜æ”¾é”®å€¼ï¼Œä¸å­˜æ”¾å®é™…æ•°æ®ã€‚</p>
  </li>
  <li>
    <p>è¦†ç›–ç´¢å¼•
åŒ…å«æ‰€æœ‰æ»¡è¶³æŸ¥è¯¢éœ€è¦çš„æ•°æ®çš„ç´¢å¼•æˆä¸ºè¦†ç›–ç´¢å¼•(Covering Index)ã€‚</p>
  </li>
  <li>æ¾æ•£ç´¢å¼•æ‰«æ
å½“ MySQL å®Œå…¨åˆ©ç”¨ç´¢å¼•æ‰«ææ¥å®ç° <code>GROUP BY</code> çš„æ—¶å€™ï¼Œå¹¶ä¸éœ€è¦æ‰«ææ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•é”®å³å¯å®Œæˆæ“ä½œå¾—å‡ºç»“æœã€‚<br />
è¦åˆ©ç”¨åˆ°æ¾æ•£ç´¢å¼•æ‰«æå®ç°GROUP BYï¼Œéœ€è¦è‡³å°‘æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š
    <ol>
      <li>GROUP BY æ¡ä»¶å­—æ®µå¿…é¡»åœ¨åŒä¸€ä¸ªç´¢å¼•ä¸­æœ€å‰é¢çš„è¿ç»­ä½ç½®ï¼›</li>
      <li>åœ¨ä½¿ç”¨GROUP BY çš„åŒæ—¶ï¼Œåªèƒ½ä½¿ç”¨MAX å’ŒMIN è¿™ä¸¤ä¸ªèšåˆå‡½æ•°ï¼›</li>
      <li>å¦‚æœå¼•ç”¨åˆ°äº†è¯¥ç´¢å¼•ä¸­GROUP BY æ¡ä»¶ä¹‹å¤–çš„å­—æ®µæ¡ä»¶çš„æ—¶å€™ï¼Œå¿…é¡»ä»¥å¸¸é‡å½¢å¼å­˜åœ¨ï¼›</li>
    </ol>
  </li>
  <li>ç´§å‡‘ç´¢å¼•æ‰«æ
ç´§å‡‘ç´¢å¼•æ‰«æå®ç°GROUP BY å’Œæ¾æ•£ç´¢å¼•æ‰«æçš„åŒºåˆ«ä¸»è¦åœ¨äºä»–éœ€è¦åœ¨æ‰«æç´¢å¼•çš„æ—¶å€™ï¼Œè¯»å–æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ç´¢å¼•é”®ï¼Œç„¶åå†æ ¹æ®è¯»å–çš„æ•°æ®æ¥å®ŒæˆGROUP BY æ“ä½œå¾—åˆ°ç›¸åº”ç»“æœã€‚</li>
</ul>

<h2 id="å®ä¾‹ä¼˜åŒ–">å®ä¾‹ä¼˜åŒ–</h2>

<h3 id="æŸ¥æ‰¾æ‰€æœ‰é¢‘é“æ­£åœ¨æ’­å‡ºçš„èŠ‚ç›®">æŸ¥æ‰¾æ‰€æœ‰é¢‘é“æ­£åœ¨æ’­å‡ºçš„èŠ‚ç›®</h3>

<p>è¡¨ç»“æ„ï¼š</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>CREATE TABLE `pt_l_program` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `lid` int(11) unsigned NOT NULL COMMENT 'é¢‘é“ID',
  `starttime` timestamp DEFAULT '0' COMMENT 'èŠ‚ç›®å¼€å§‹æ—¶é—´',
  `program` varchar(255) DEFAULT '' COMMENT 'èŠ‚ç›®å•',
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique` (`lid`,`starttime`),
) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='èŠ‚ç›®å•';
</pre></div>
</div>
</div>

<p>SQLï¼š</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>select SQL_SMALL_RESULT SQL_NO_CACHE  p1.id, p1.program, p1.starttime, p1.lid  from pt_l_program p1 inner join 
(select  max(starttime) as starttime,lid from pt_l_program where starttime&lt;=UNIX_TIMESTAMP()  group by lid order by null) p2 
on p1.lid=p2.lid and p1.starttime=p2.starttime;
</pre></div>
</div>
</div>

<p>ç´¢å¼•ï¼š</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>CREATE  INDEX Group_Search ON pt_l_program (lid,starttime,id,program);
</pre></div>
</div>
</div>

<p>Explain:<br />
åˆ†ç»„æ—¶ä½¿ç”¨æ¾æ•£ç´¢å¼•æ‰«æï¼Œèšåˆæ•°æ®æ—¶ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå®Œå…¨é¿å…äº†ç£ç›˜IOã€‚å¦‚æœéœ€è¦è€ƒè™‘æ’å…¥æ€§èƒ½ï¼Œåˆ™å¯ä»¥å»æ‰<code>Group_Search</code>ã€‚
<img src="/assets/image/20141214001406.png" alt="" /></p>

<h2 id="é—®é¢˜æ‰©å±•">é—®é¢˜æ‰©å±•</h2>

<h3 id="åˆ†ç»„å–å‰næ¡å€¼åˆ†ç»„å–ç¬¬næ¡å€¼">åˆ†ç»„å–å‰næ¡å€¼/åˆ†ç»„å–ç¬¬næ¡å€¼</h3>

<p>é—®é¢˜æœ‰ç‚¹éš¾åº¦ï¼Œä½†SQLè¿˜æ˜¯å¯ä»¥å®ç°ï¼š</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>set @num :=0, @lid := '';
select id, program,from_unixtime( starttime),channel_id  from (
        select id, program,starttime,
      @num := if(@lid = lid, @num + 1, 1) as row_number,
      @lid := lid as channel_id
  from pt_l_program
        where   starttime&lt;=unix_timestamp()
  order by lid, starttime desc 
) as p where p.row_number &lt;= 2;
</pre></div>
</div>
</div>

<p>åˆ©ç”¨Havingè¿‡æ»¤ï¼š</p>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>set @num :=0, @lid := '', @now := 0;
desc select id, program,from_unixtime(starttime),
      @num := if(@lid = lid and @now&lt;starttime, @num + 1, 1) as row_number,
      @lid := lid as channel_id
from pt_l_program
where starttime&lt;=unix_timestamp() group by lid, starttime desc having row_number&lt;=2;
</pre></div>
</div>
</div>

<hr />

<h1 id="nosql">NoSQL</h1>

<p>æ•°æ®åº“ï¼šMongoDB</p>

<h2 id="åè¯è§£é‡Š-1">åè¯è§£é‡Š</h2>

<p>èšåˆç®¡é“ï¼šç®¡é“æ˜¯MongoDB2.2ç‰ˆæœ¬å¼•å…¥æ–°çš„åŠŸèƒ½ ï¼Œå®ƒæ˜¯æ•°æ®èšåˆçš„ä¸€ä¸ªæ–°æ¡†æ¶ï¼Œå…¶æ¦‚å¿µç±»ä¼¼äºæ•°æ®å¤„ç†çš„ç®¡é“ã€‚</p>

<h2 id="å¯¼å…¥æ•°æ®">å¯¼å…¥æ•°æ®</h2>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>mongoimport --type csv --file ~/program.csv --db pt --collection program --fields id,lid,starttime,program
</pre></div>
</div>
</div>

<h2 id="èšåˆ">èšåˆ</h2>

<div class="language-plaintext highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre>db.program.aggregate(
[
{$match:{}},
{ $project : { id : 1 , lid : 1, program:1, starttime:{$multiply:[&quot;$starttime&quot;, 1000]} } },
{$sort:{&quot;lid&quot;:-1, &quot;starttime&quot;:1}},
{$group : { _id :&quot;$lid&quot;, program:{$first:&quot;$program&quot;}, starttime:{$first:&quot;$starttime&quot;  }}}
],
{explain:true}
)
</pre></div>
</div>
</div>

<hr />

<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p><a href="http://www.xaprb.com/blog/2006/12/07/how-to-select-the-firstleastmax-row-per-group-in-sql/">How to select the first/least/max row per group in SQL</a><br />
<a href="http://www.51testing.com/html/52/n-229952.html">è¯¦è§£MySQLåˆ†ç»„æŸ¥è¯¢Group Byå®ç°åŸç†</a><br />
<a href="http://www.cnmiss.cn/?p=373">MySQLä¼˜åŒ–GROUP BYï¼æ¾æ•£ç´¢å¼•æ‰«æä¸ç´§å‡‘ç´¢å¼•æ‰«æ</a><br />
<a href="http://www.iteedu.com//database/mysql/mysqlmanualcn/optimization/group-by-optimization.php">MySQLå¦‚ä½•ä¼˜åŒ–GROUP BY</a><br />
<a href="http://www.coder4.com/archives/1344">æ¾æ•£çš„ç´¢å¼•æ‰«æ(Loose index scan)</a><br />
<a href="http://blog.csdn.net/dbanote/article/details/9083109">[MySQL] ç´¢å¼•ä¸æ€§èƒ½ï¼ˆ1ï¼‰- ç´¢å¼•ç±»å‹</a><br />
<a href="http://www.cnblogs.com/Arlen/articles/1751227.html">MyISAM ç´¢å¼•ç»“æ„äº†è§£ â€“ MyISAM Index Structure</a><br />
<a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html">MySQLç´¢å¼•èƒŒåçš„æ•°æ®ç»“æ„åŠç®—æ³•åŸç†</a></p>

:ET