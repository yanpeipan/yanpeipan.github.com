<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-java-concurrency-in-practice/对象的共享" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">第3章 对象的共享 | 织码如诗</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://yanpeipan.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://yanpeipan.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的共享"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第3章 对象的共享 | 织码如诗"><meta data-rh="true" name="description" content="对象的共享"><meta data-rh="true" property="og:description" content="对象的共享"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的共享"><link data-rh="true" rel="alternate" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的共享" hreflang="en"><link data-rh="true" rel="alternate" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的共享" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="织码如诗 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="织码如诗 Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.16c07b82.css">
<script src="/assets/js/runtime~main.2e711170.js" defer="defer"></script>
<script src="/assets/js/main.92103e4c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="织码如诗" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="织码如诗" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">织码如诗</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/intro">Java基础</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/java-concurrency-in-practice/简介">Java并发编程</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">数据库</a><ul class="dropdown__menu"><li>MySQL</li><li><a class="dropdown__link" href="/docs/mysql/2023">MySQL</a></li><li><a class="dropdown__link" href="/docs/redis/概述">Redis</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/简介">第1章 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/线程安全性">第2章 线程安全性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/java-concurrency-in-practice/对象的共享">第3章 对象的共享</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/对象的组合">第4章 对象的组合</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/基础构建模块">第5章 基础构建模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/任务执行">第6章 任务执行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/取消与关闭">第7章 取消与关闭</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/线程池的使用">第8章 线程池的使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/避免活跃性危险">第10章 避免活跃性危险</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/性能与可伸缩性">第11章 性能与可伸缩性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/并发程序的测试">第12章 并发程序的测试</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/显示锁">第13章 显示锁</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/构建自定义的同步工具">第14章 构建自定义的同步工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/原子变量与非阻塞同步机制">第15章 原子变量与非  阻塞同步机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/Java内存模型">第16章 Java内存模型</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第3章 对象的共享</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第3章 对象的共享</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="对象的共享">对象的共享<a href="#对象的共享" class="hash-link" aria-label="Direct link to 对象的共享" title="Direct link to 对象的共享">​</a></h2>
<p>同步synchronized不仅可用于原子性或者确定临界区（Critical Section），还可以保证内存可见性（Memory Visibility）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-可见性">3.1 可见性<a href="#31-可见性" class="hash-link" aria-label="Direct link to 3.1 可  见性" title="Direct link to 3.1 可见性">​</a></h3>
<p>重排序（Reordering）读线程看到的顺序与写入的顺序完全相反</p>
<ul>
<li>编译器优化的重排序</li>
<li>指令级并行的重排序</li>
<li>内存系统的重排序</li>
</ul>
<p><a href="https://tech.meituan.com/2014/09/23/java-memory-reordering.html" target="_blank" rel="noopener noreferrer">Java内存访问重排序的研究</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="311-失效数据">3.1.1 失效数据<a href="#311-失效数据" class="hash-link" aria-label="Direct link to 3.1.1 失效数据" title="Direct link to 3.1.1 失效数据">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="312-非原子的64位操作">3.1.2 非原子的64位操作<a href="#312-非原子的64位操作" class="hash-link" aria-label="Direct link to 3.1.2 非原子的64位操作" title="Direct link to 3.1.2 非原子的64位操作">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="313-加锁与可见性">3.1.3 加锁与可见性<a href="#313-加锁与可见性" class="hash-link" aria-label="Direct link to 3.1.3 加锁与可见性" title="Direct link to 3.1.3 加锁与可见性">​</a></h4>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="314-volatile变量">3.1.4 Volatile变量<a href="#314-volatile变量" class="hash-link" aria-label="Direct link to 3.1.4 Volatile变量" title="Direct link to 3.1.4 Volatile变量">​</a></h4>
<p>用来确保将变量的更新操作通知到其它线程</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-发布与逸出">3.2 发布与逸出<a href="#32-发布与逸出" class="hash-link" aria-label="Direct link to 3.2 发布与逸出" title="Direct link to 3.2 发布与逸出">​</a></h3>
<p>发布对象（Publish）：使对象在当前作用域之外的代码中使用</p>
<p>当某个不该发布的对象被发布时，逸出（Escape）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class UnsafeStates {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private String[] states = new String[] {&quot;AL&quot;, &quot;AK&quot;};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String[] getStates() { return states; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>隐式使this引用逸出</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ThisEscape {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ThisEscape(EventSource source) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        source.registerListener( </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new EventListener() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 内部类初始化之后，已经拿到父类的this引用，但此时父类还没初始化完成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void onEvent(Event e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doSt(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>安全的对象构造过程，不要在构造过程中使this引用逸出</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class SafeListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final EventListener listener;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SafeListener() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        listener = new EventListener() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void onEvent(Event e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doSt(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static SafeListener newInstance(EventSource source) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SafeListener safe = new SafeListener();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        source.registerListener(safe.listener);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return safe;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-线程封闭">3.3 线程封闭<a href="#33-线程封闭" class="hash-link" aria-label="Direct link to 3.3 线程封闭" title="Direct link to 3.3 线程封闭">​</a></h3>
<p>避免同步，不使用共享数据。</p>
<p>单线程内访问数据，线程封闭（Thread Confinement）</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="331-ad-hoc线程封闭">3.3.1 Ad-hoc线程封闭<a href="#331-ad-hoc线程封闭" class="hash-link" aria-label="Direct link to 3.3.1 Ad-hoc线程封闭" title="Direct link to 3.3.1 Ad-hoc线程封闭">​</a></h4>
<p>完全由程序实现来承担，尽量少用</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="332-栈封闭">3.3.2 栈封闭<a href="#332-栈封闭" class="hash-link" aria-label="Direct link to 3.3.2 栈封闭" title="Direct link to 3.3.2 栈封闭">​</a></h4>
<p>只有局部变量才能访问对象</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="333-threadlocal">3.3.3 ThreadLocal<a href="#333-threadlocal" class="hash-link" aria-label="Direct link to 3.3.3 ThreadLocal" title="Direct link to 3.3.3 ThreadLocal">​</a></h4>
<p>通常用于防止对可变的单实例变量（Singleton）和全局变量进行共享</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-不变性">3.4 不变性<a href="#34-不变性" class="hash-link" aria-label="Direct link to 3.4 不变性" title="Direct link to 3.4 不变性"> ​</a></h3>
<p>不可变对象（Immutable Object）一定是线程安全的，满足同步</p>
<ul>
<li>
<p>对象创建以后其状态就不能修改</p>
</li>
<li>
<p>对象的所有域都是final类型</p>
</li>
<li>
<p>对象是正确创建的（在对象创建期间，this引用没有逸出）</p>
<p>保存在不可变对象中的程序仍然可以更新，即通过将一个保存新状态的实例来替换原有的不可变对象</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="341-final域">3.4.1 Final域<a href="#341-final域" class="hash-link" aria-label="Direct link to 3.4.1 Final域" title="Direct link to 3.4.1 Final域">​</a></h4>
<p>JAVA内存模型，final域确保初始化过程中的安全性，从而可以不受限制的访问不可变对象，且共享访问时无需同步。</p>
<p>final域重排序规则：</p>
<ul>
<li>
<p>在构造函数内对一个final域的写入，与随后把这个被构造对象的引用赋值给一个引用 变量，这两个操作之间不能重排序。</p>
</li>
<li>
<p>初次读一个包含final域的对象的引用，与随后初次读这个final域，这两个操作之间不能 重排序。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FinalExample {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 普通变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // final变量</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final int j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static FinalExample obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 构造函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FinalExample() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 写普通域，可能重排序到构造函数之外，i = 1 还没写入普通域i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        i = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 写final域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        j = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 写线程A执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void writer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj = new FinalExample();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 读线程B执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void reader() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读对象引用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FinalExample object = obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读普通域，可能重排序到“读对象引用”之前，线程A还没写入i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int a = object.i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读final域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int b = object.j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>写final域的重排序规则</p>
<ul>
<li>JMM禁止编译器把final域的写重排序到构造函数之外</li>
<li>编译器会在final域的写之后，构造函数return之前，插入一个StoreStore屏障。这个屏障禁止处理器把final域的写重排序到构造函数之外</li>
</ul>
<p>读final域的重排序规则</p>
<ul>
<li>在一个线程中，初次读对象引用与初次读该对象包含的final 域，JMM禁止处理器重排序这两个操作（注意，这个规则仅仅针对处理器）。编译器会在读final域 操作的前面插入一个LoadLoad屏障。</li>
</ul>
<p>final域为引用类型</p>
<p>1是对final域的写入，2是对这个final域引用的对象的成员域的写入，3是把被构造的对象的引用赋值给某个引用变量。这里除了前面提到的1不能和3重排序外，2和3也不能重排序。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 假设首先线程A执行writerOne()方法，执行完后线程B执行 writerTwo()方法，执行完后线程C执行reader()方法。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * JMM不保证线程B的写入对读线程C可见，因为写线程B和读线程C之间存在数 据竞争，此时的执行结果不可预知。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 写线程B和读线程C之间需要使 用同步原语（lock或volatile）来确保内存可见性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class FinalReferenceExample {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final int[] intArray;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static FinalReferenceExample obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FinalReferenceExample() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1: 写final引用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        intArray = new int[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2: 写final引用对象的成员域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        intArray[0] = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 写线程A执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void writeOne() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3: 把构造对象的引用赋值给引用变量obj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj = new FinalReferenceExample();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 写线程B执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void writeTwo() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4: 写final引用对象的成员域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj.intArray[0] = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 读线程C执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void reader() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5: 读对象引用obj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (obj != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 6: 读final引用的成员域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int temp1 = obj.intArray[0];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为什么final引用不能从构造函数内“溢出”</p>
<p>保证在构造器内部，不能让这个被构造对象的引用为其它线程所见，也就是对象引用不能在构造函数中“逸出”。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class FinalReferenceEscapeExample {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final int i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static FinalReferenceEscapeExample obj;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FinalReferenceEscapeExample() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1：写final域</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        i = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2：this引用在此逸出，1，2可能被重排序</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        obj = this;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void writer() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new FinalReferenceEscapeExample();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void reader() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读取不为null的对象引用a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (obj != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 可能读取到final域初始化之前的值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int temp = obj.i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="342-volatile类型发布不可变对象">3.4.2 Volatile类型发布不可变对象<a href="#342-volatile类型发布不可变对象" class="hash-link" aria-label="Direct link to 3.4.2 Volatile类型发布不可变对象" title="Direct link to 3.4.2 Volatile类型发布不可变对象">​</a></h4>
<p>不可变对象能够提供一种弱形式的原子性</p>
<p>当需要对一组相关数据以原子方式执行某个操作，就可以考虑创建一个不可变的类来包含这些数据</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Immutable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OneValueCache {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BigInteger lastNumber;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final BigInteger[] lastFactors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OneValueCache(BigInteger i,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         BigInteger[] factors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lastNumber = i;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lastFactors = Arrays.copyOf(factors, factors.length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BigInteger[] getFactors(BigInteger i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (lastNumber == null || !lastNumber.equals(i))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Arrays.copyOf(lastFactors, lastFactors.length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><a href="https://juejin.cn/post/6844903601068998664" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903601068998664</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class VolatileCachedFactorizer extends GenericServlet implements Servlet {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 可见性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private volatile OneValueCache cache = new OneValueCache(null, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void service(ServletRequest req, ServletResponse resp) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BigInteger i = extractFromRequest(req);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BigInteger[] factors = cache.getFactors(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (factors == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            factors = factor(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // i 和 factors 是一一对应的，保障了缓存一致性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cache = new OneValueCache(i, factors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        encodeIntoResponse(resp, factors);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void encodeIntoResponse(ServletResponse resp, BigInteger[] factors) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BigInteger extractFromRequest(ServletRequest req) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new BigInteger(&quot;7&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BigInteger[] factor(BigInteger i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Doesn&#x27;t really factor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new BigInteger[]{i};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="35-安全发布">3.5 安全发布<a href="#35-安全发布" class="hash-link" aria-label="Direct link to 3.5 安全发布" title="Direct link to 3.5 安全发布">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="351-不正确的发布正确的对象被破坏">3.5.1 不正确的发布：正确的对象被破坏<a href="#351-不正 确的发布正确的对象被破坏" class="hash-link" aria-label="Direct link to 3.5.1 不正确的发布：正确的对象被破坏" title="Direct link to 3.5.1 不正确的发布：正确的对象被破坏">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Holder holder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void initialize() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 由于可见性问题，其它线程看到尚未创建完成的对象</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	holder = new Holder(42);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>不能指望尚未完全创建的对象拥有完整性。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Holder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private int n;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public Holder(int n) { this.n = n; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public void assertSanity() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 第一次读取到失效值，再次读取得到更新值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if (n != n) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			thrown new AssertionError(&quot;This statement is false.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="352-不可变对象与初始化安全性">3.5.2 不可变对象与初始化安全性<a href="#352-不可变对象与初始化安全性" class="hash-link" aria-label="Direct link to 3.5.2 不可变对象与初始化安全性" title="Direct link to 3.5.2 不可变对象与初始化安全性">​</a></h4>
<p>Java内存模型为不可变对象的共享提供了一种特殊的初始化安全性保证。</p>
<p>任何钱程都可以在不需妥额外同步的情况下安全地访问不可变对象，即使在发布这些对象时没有使用同步。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="353-安全发布的常用模式">3.5.3 安全发布的常用模式<a href="#353-安全发布的常用模式" class="hash-link" aria-label="Direct link to 3.5.3 安全发布的常用模式" title="Direct link to 3.5.3 安全发布的常用模式">​</a></h4>
<ul>
<li>在静态初始化函数中初始化一个对象引用</li>
<li>将对象的引用保存到volatile类型的域或者AtomicReferance对象中</li>
<li>将对象的引用保存到某个正确构造对象的final类型域中</li>
<li>将对象的引用保存到某个正确构造对象的fianl类型域中</li>
<li>将对象的引用保存到一个由锁保护的域中</li>
</ul>
<p>线程安全库中的容器类提供了安全发布保证：</p>
<ul>
<li>将一个键或者值放入Hashtable、synchronizedMap或者ConcurrentMap中，可以安全的将它发布给任何从这些容器访问它的线程</li>
<li>将某些元素放入Vector、CopyOnWriteArrayList、CopyOnWriteArraySet、synchronizedList或synchronizedSet中，可以将该元素发布到任何从这些容器中访问该元素的线程</li>
<li>将某个元素放入BlockingQueue或ConcurrentLinkedQueue中，可以将该元素安全地发布到任何从这些队列中访问该元素的线程</li>
</ul>
<p>类库中的其它传递机制（Future、Exchanger）同样能实现安全发布</p>
<p>发布静态构造的对象，最简单和最安全的方式是使用静态的初始化器：</p>
<p><code>public static Holder holder = new Holder(42);</code></p>
<p>静态初始化器由JVM 在类的初始化阶段执行。由于在 JVM 内部存在着同步机制，因此通过这种方式初始化的任何对象都可以坡安全地发布［JLS 12.4.2］。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="354-事实不可变对象">3.5.4 事实不可变对象<a href="#354-事实不可变对象" class="hash-link" aria-label="Direct link to 3.5.4 事实不可变对象" title="Direct link to 3.5.4 事实不可变对象">​</a></h4>
<p>如果对象从技术上来看是可变的，但其状态在发布后不会再改变，那么提这种对象称为“事实不可变对象（ Effectively Immutable Object)”</p>
<p>在没是有额外的同步的情况下，任何线程都可以安全地使用被安全发布的事实不可变对象</p>
<p><code>public Map&lt;String, Date&gt; lastLogin = Collections.synchronizedMap(new HashMap&lt;String, Date&gt;);</code></p>
<p>保存每位用户的最近登录时间，如果Date对象的值放入Map后就不会改变，那么synchronizedMap中的同步机制足以使Date值被安全发布，并且访问Date值时不需要额外的同步。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="355-可变对象">3.5.5 可变对象<a href="#355-可变对象" class="hash-link" aria-label="Direct link to 3.5.5 可变对象" title="Direct link to 3.5.5 可变对象">​</a></h4>
<p>可变对象在构造后可以修改，不仅在发布对象时需要使用同步，而且在每次对象访问时需要使用同步来确保后续修改操作的可见性。</p>
<p>对象的发布需求取决于它的可变性：</p>
<ul>
<li>
<p>不可变对象可以通过任意机制来发布</p>
</li>
<li>
<p>事实不可变对象必须通过安全方式来发布</p>
</li>
<li>
<p>可变对象必须通过安全方  式来发布，并且必须是线程安全的或者由某个锁保护起来</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="356-安全的共享对象">3.5.6 安全的共享对象<a href="#356-安全的共享对象" class="hash-link" aria-label="Direct link to 3.5.6 安全的共享对象" title="Direct link to 3.5.6 安全的共享对象">​</a></h4>
<ul>
<li>线程封闭</li>
<li>只读共享，包括不可变对象和事实不可变对象</li>
<li>线程安全共享，线程安全的对象在其内部实现同步，因此多个线程可以通过对象的公有接口来进行访问而不需要进一步的同步</li>
<li>保护对象，封装在其他线程安全对象中的对象，以及已发布的并且由某个特定锁保护的对象</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/java">Java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/concurrency">concurrency</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/java-concurrency-in-practice/03-对象的共享.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/java-concurrency-in-practice/线程安全性"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第2章 线程安全性</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/java-concurrency-in-practice/对象的组合"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第4章 对象的组合</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#对象的共享" class="table-of-contents__link toc-highlight">对象的共享</a><ul><li><a href="#31-可见性" class="table-of-contents__link toc-highlight">3.1 可见性</a></li><li><a href="#32-发布与逸出" class="table-of-contents__link toc-highlight">3.2 发布与逸出</a></li><li><a href="#33-线程封闭" class="table-of-contents__link toc-highlight">3.3 线程封闭</a></li><li><a href="#34-不变性" class="table-of-contents__link toc-highlight">3.4 不变性</a></li><li><a href="#35-安全发布" class="table-of-contents__link toc-highlight">3.5 安全发布</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>