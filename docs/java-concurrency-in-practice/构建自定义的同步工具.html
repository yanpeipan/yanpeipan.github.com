<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-java-concurrency-in-practice/构建自定义的同步工具" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">第14章 构建自定义的同步工具 | 织码如诗</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://yanpeipan.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://yanpeipan.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://yanpeipan.github.io/docs/java-concurrency-in-practice/构建自定义的同步工具"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第14章 构建自定义的同步工具 | 织码如诗"><meta data-rh="true" name="description" content="创建状态依赖类的最简单方式通常是在类库中现有状在载赖类的基础上进行构造"><meta data-rh="true" property="og:description" content="创建状态依赖类的最简单方式通常是在类库中现有状在载赖类的基础上进行构造"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/构建自定义的同步工具"><link data-rh="true" rel="alternate" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/构建自定义的同步工具" hreflang="en"><link data-rh="true" rel="alternate" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/构建自定义的同步工具" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="织码如诗 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="织码如诗 Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.16c07b82.css">
<script src="/assets/js/runtime~main.2e711170.js" defer="defer"></script>
<script src="/assets/js/main.5314265e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="织码如诗" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="织码如诗" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">织码如诗</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/intro">Java基础</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/java-concurrency-in-practice/简介">Java并发编程</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">数据库</a><ul class="dropdown__menu"><li>MySQL</li><li><a class="dropdown__link" href="/docs/mysql/2023">MySQL</a></li><li><a class="dropdown__link" href="/docs/redis/概述">Redis</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/简介">第1章 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/线程安全性">第2章 线程安全性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/对象的共享">第3章 对象的共享</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/对象的组合">第4章 对象的组合</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/基础构建模块">第5章 基础构建模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/任务执行">第6章 任务执行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/取消与关闭">第7章 取消与关闭</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/线程池的使用">第8章 线程池的使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/避免活跃性危险">第10章 避免活跃性危险</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/性能与可伸缩性">第11章 性能与可伸缩性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/并发程序的测试">第12章 并发程序的测试</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/显示锁">第13章 显示锁</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/java-concurrency-in-practice/构建自定义的同步工具">第14章 构建自定义的同步工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/原子变量与非阻塞同步机制">第15章 原子变量与非  阻塞同步机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/Java内存模型">第16章 Java内存模型</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第14章 构建自定义的同步工具</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第14章 构建自定义的同步工具</h1></header><p>创建状态依赖类的最简单方式通常是在类库中现有状在载赖类的基础上进行构造</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="状态依赖性的管理">状态依赖性的管理<a href="#状态依赖性的管理" class="hash-link" aria-label="Direct link to 状态依赖性的管理" title="Direct link to 状态依赖性的管理">​</a></h2>
<p>可阻塞的状态依赖操作的结构</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// acquire lock on object state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">while (precondition dose not hold) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    release lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wait until precondition might hold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        optionally fail if interrupted on timeout expires</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reacquire lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">perform action</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    release lock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有界缓存实现的基类</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class BaseBoundedBuffer&lt;V&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final V[] buf;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuradedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int tail;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int head;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected BaseBoundedBuffer(int capacity) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.buf = (V[])new Object[capacity];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected synchronized final void doPut(V v) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        buf[tail] = v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (++tail == buf.length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tail = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ++count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected synchronized final V doTake() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        V v = buf[head];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        buf[head] = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (++head == buf.length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            head = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        --count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized final boolean isFull() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return count == buf.length;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized final boolean isEmpty() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return count == 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="示例将前提条件的失败传递给调用者">示例：将前提条件的失败传递给调用者<a href="#示例将前提条件的失败传递给调用者" class="hash-link" aria-label="Direct link to 示例：将前提条件的失败传递给调用者" title="Direct link to 示例：将前提条件的失败传递给调用者">​</a></h3>
<p>当不满足前提条件时，有界缓存不会执行相应操作</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class GrumpyBoundedBuffer&lt;V&gt; extends BaseBoundedBuffer&lt;V&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GrumpyBoundedBuffer(int size) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void put(V v) throws BufferFullException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isFull()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new BufferFullException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doPut(v);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized V take() throws BufferEmptyException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new BufferEmptyException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return doTake();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="示例通过轮询与休眠来实现简单的阻塞">示例：通过轮询与休眠来实现简单的阻塞<a href="#示例通过轮询与休眠来实现简单的阻塞" class="hash-link" aria-label="Direct link to 示例：通过轮询与休眠来实现简单的阻塞" title="Direct link to 示例：通过轮询与休眠来实现简单的阻塞">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SleepyBoundedBuffer&lt;V&gt; extends BaseBoundedBuffer&lt;V&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SleepyBoundedBuffer(int size) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void put(V v) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            synchronized (this) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!isFull()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    doPut(v);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread.sleep(SLEEP_GRANULARITY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public V take() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            synchronized (this) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (!isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return doTake();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Thread.sleep(SLEEP_GRANULARITY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="条件队列">条件队列<a href="#条件队列" class="hash-link" aria-label="Direct link to 条件队列" title="Direct link to 条件队列">​</a></h3>
<p>使用条件队列实现的有界缓存</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BoundedBuffer&lt;V&gt; extends BaseBoundedBuffer&lt;V&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BoundedBuffer(int size) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 阻塞直到 not-full</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void put(V v) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (isFull()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wait();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        doPut(v);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        notfiyAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 阻塞直到 not-empty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized V take() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wait();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        V v = doTake();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        notifyAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用条件队列">使用条件队列<a href="#使用条件队列" class="hash-link" aria-label="Direct link to 使用条件队列" title="Direct link to 使用条件队列">​</a></h2>
<p>条件队列使构建高效以及高可响应性的状态依赖类变得更容易， 但同时也很容易被不正确地使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="条件谓词">条件谓词<a href="#条件谓词" class="hash-link" aria-label="Direct link to 条件谓词" title="Direct link to 条件谓词">​</a></h3>
<p>关键找出对象在哪个条件谓词上等待</p>
<p>每次wait调用都会隐式的与特定的条件谓词关联起来。当调用某个特定条件谓词的wait时，调用者必须已经持有与条件队列相关的锁，并且这个锁必须保持着构成条件谓词的状态变量</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="过早唤醒">过早唤醒<a href="#过早唤醒" class="hash-link" aria-label="Direct link to 过早唤醒" title="Direct link to 过早唤醒">​</a></h3>
<p>内置条件队列可以与多个条件谓词一起使用。当一个线程由于调用 notifyAll 而醒来时，并不意味该线程正在等待的条件谓词已经变成真了。</p>
<p>所以，每当线程从wait中唤醒时，都必须再次测试条件谓词</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">void stateDependentMethod() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (lock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (!conditionPredicate()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.wait();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当使用条件等待时（Object.wait  或 Condition.await）</p>
<ul>
<li>通常都有一个条件谓词--包括 一些对象的状态的测试，线程在执行前必须首先通过这些测试</li>
<li>在调用wait之前测试条件谓词，并且从wait中返回时再次进行测试</li>
<li>在一个循环中调用wait</li>
<li>确保使用与条件队列相关的锁来保护构成条件谓词的各个状态变量</li>
<li>当调用wait，notify，notifyAll等方法时，一定要持有与条件队列相关的锁</li>
<li>在检查条件谓词之后以及开始执行相关的操作之前，不要释放锁</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="丢失的信号">丢失的信号<a href="#丢失的信号" class="hash-link" aria-label="Direct link to 丢失的信号" title="Direct link to 丢失的信号">​</a></h3>
<p>丢失的信号是指：线程必须等待一个已经为真的条件，但在开始等待之前没有检查条件谓词。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="通知">通知<a href="#通知" class="hash-link" aria-label="Direct link to 通知" title="Direct link to 通知">​</a></h3>
<p>每当在等待一个条件时，一定要确保在条件谓词变为真时通过某种方式发出通知</p>
<p>只有同时满足两个条件，才能用单一的notify而不是notifyAll</p>
<ul>
<li>
<p>所有等待线程的类型都相同。只有一个条件谓词与条件队列相关，并且每个线程在从wait返回后将执行相同的操作</p>
</li>
<li>
<p>单进单出。在条件变量上的每次通知，最多只能唤醒一个线程来执行。</p>
</li>
</ul>
<p>普遍认可的做法是忧先使用 notifyAll 而不是notify. 虽然 notifyAll 可能比 notiy更低效，但却更容易确保类的行为是正确的。</p>
<p>在每个结程执行一个事件的同时，将出现大量的上下文切换操作以及发生竞争的锁获取操作。（最坏的情况是，在使notifyAll 时将导致 <code>O(n^2)</code> 次唤醒操作，而实际上只需要 n次唤醒操作就足够了）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public synchronized void put(V v) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (ifFull()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wait();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean wasEmpty = isEmpty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    doPut(v);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (wasEmpty) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        notifyAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="示例阀门类">示例： 阀门类<a href="#示例阀门类" class="hash-link" aria-label="Direct link to 示例：阀门类" title="Direct link to 示例：阀门类">​</a></h3>
<p>使用wait和notifyAll来实现可重新关闭的阀门</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ThreaadGate {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isOpen;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int generation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void close() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isOpen = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void open() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ++generation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        isOpen = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        notifyAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void await() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int arrivalGeneration = generation;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (!isOpen &amp;&amp; arrivalGeneration == generation) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            wait();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="子类的安全问题">子类的安全问题<a href="#子类的安全问题" class="hash-link" aria-label="Direct link to 子类的安全问  题" title="Direct link to 子类的安全问题">​</a></h3>
<p>如果在实施子类化时违背了条件通知或单次通知的某个需求，那么在子类中可以增加合适的通知机制来代表基类。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="封装条件队列">封装条件队列<a href="#封装条件队列" class="hash-link" aria-label="Direct link to 封装条件队列" title="Direct link to 封装条件队列">​</a></h3>
<p>通常，我们应该把条件队列封装起来，因而除了使用条件队列的类，就不能在其他地方坊访问它。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="入口协议与出口协议">入口协议与出口协议<a href="#入口协议与出口协议" class="hash-link" aria-label="Direct link to 入口协议与出口协议" title="Direct link to 入口协议与出口协议">​</a></h3>
<p>人口协议和出口协议（ Entry and Exit Protocols ）”来描述wait notify方法的正确使用。对于每个依赖状态的操件，以及每个修改其他操作依赖状态的操作，都应该定义一个入口协议和出口协议。入口协议就是该操作的条件谓词，出口协议则包括，检查被该操作修改的所有状态变量，并确认它们是否使某个其他的条件谓词变为真，如是，则通知相关的条件队列。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="显式的condition对象">显式的Condition对象<a href="#显式的condition对象" class="hash-link" aria-label="Direct link to 显式的Condition对象" title="Direct link to 显式的Condition对象">​</a></h2>
<p>Condition也是一种广义的内置条件队列</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Condition {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void await() throws InterruptedException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean await(long time, TimeUnit unit) throws InterruptedException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long awaitNanos(long nanosTImeout) throws InterruptedException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void awaitUninterruptibly();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean awaitUntil(Date deadline) throws InterruptedException;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void signal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void signalAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Condition比内置条件队列提供了更丰富的功能：在每个锁上可存在多个等待/条件等待可以时可中断或不可中断，基于时限的等待，以及公平的或非公平的队列操作</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConditionBoundedBuffer&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected final Lock lock = new ReentrantLock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Condition notFull = lock.newCondition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Condition notEmpty = lock.newCondition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;lock&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final T[] items = (T[])new Object[BUFFER_SIZE];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;lock&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int tail, head, count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 阻塞直到notFull</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void put(T x) throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (count == items.length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                notFull.await();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            items[tail] = x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (++tail == items.length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tail = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ++count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            notEmpty.signal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 阻塞直到notEmpty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public T take() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (count == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                notEmpty.await();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            T x = items[head];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            items[head] = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (++head == items.length) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                head = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            --count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            notFull.signal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="synchronized剖析">Synchronized剖析<a href="#synchronized剖析" class="hash-link" aria-label="Direct link to Synchronized剖析" title="Direct link to Synchronized剖析">​</a></h2>
<p>AQS 是一个用于构建锁和同步器的框架，许多同步器都可以通过 AQS 很容易并且高效地构造出来。</p>
<p>使用Lock来实现信号量</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SemaphoreOnLock{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Lock lock = new ReentrantLock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Condition permitsAvailable = lock.newCondition();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int permits;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SemaphoreOnLock(int initialPermits) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            permits = initialPermits;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void acquire() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (permits &lt;= 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                permitsAvailable.await();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                --permits;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void release() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ++permits;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            permitsAvailable.signal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="abstractqueuedsynchronizer">AbstractQueuedSynchronizer<a href="#abstractqueuedsynchronizer" class="hash-link" aria-label="Direct link to AbstractQueuedSynchronizer" title="Direct link to AbstractQueuedSynchronizer">​</a></h2>
<p>AQS中获取和释放操作的标准形式</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">boolean acquire() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (当前状态不允许获取操作) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (需要阻塞获取请求) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            如果当前线程不在队列中，则将其插入队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            阻塞当前线程</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            返回失败</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    可能更新同步器的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    如果线程位于队列中，则将其移除队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    返回成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void release() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    更新同步器的状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (新的状态允许某个被阻塞的线程获取成功) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        接触队列中一个或多个线程的阻塞状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用AbstractQueueSynchronizer实现的二元闭锁</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OneShotLatch{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Sync sync = new Sync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void signal() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sync.releaseShared(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void await() throws InterruptedException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sync.acquireSharedInterruptibly(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private class Sync extends AbstractQueueSynchronizer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected int tryAcquireShared(int ignored) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return (getState() == 1) ? 1 : -1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected boolean tryReleaseShared(int ignored) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            setState(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="javauntilconcurrent同步器类中的aqs">java.until.concurrent同步器类中的AQS<a href="#javauntilconcurrent同步器类中的aqs" class="hash-link" aria-label="Direct link to java.until.concurrent同步器类中的AQS" title="Direct link to java.until.concurrent同步器类中的AQS">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reentrantlock">ReentrantLock<a href="#reentrantlock" class="hash-link" aria-label="Direct link to ReentrantLock" title="Direct link to ReentrantLock">​</a></h3>
<p>ReentrantLock 只支持强占方式的获取操作，因此它实现了tryAcquire tryRelease和isHeldExclusively</p>
<p>基于非公平的ReentrantLock实现tryAcquire</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean tryAcquire(int ignored) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Thread current = Thread.currentThread();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int c = getState();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (c == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (compareAndSetState(0, 1)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            owner = current;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else if (current == owner) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        setState(c + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="semaphore与countdownlatch">Semaphore与CountDownLatch<a href="#semaphore与countdownlatch" class="hash-link" aria-label="Direct link to Semaphore与CountDownLatch" title="Direct link to Semaphore与CountDownLatch">​</a></h3>
<p>Semaphore中的tryAcquireShared与tryRleaseShared</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protected int tryAcquireShared(int acquires) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int available = getState();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int remaining = available - acquires;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (remaining &lt; 0 || compareAndSetState(available, remaining)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return remaining;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean tryReleaseShared(int releases) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int p = getState();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (compareAndSetState(p, p + releases)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="futuretask">FutureTask<a href="#futuretask" class="hash-link" aria-label="Direct link to FutureTask" title="Direct link to FutureTask">​</a></h3>
<p>FutureTask 中， AQS 同步状态被用来保存任务的状态，例如，正在运行、已完成或已取消。 FutureTask 还维护一些额外的状态变量，用来保存计算结果或者抛出的异常。此外，它还维护了一个引用，指向正在执行计算任务的线程〈如果它当前处于运行状态〉，因而如果任务取消，该线程会中断。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="reentrantreadwritelock">ReentrantReadWriteLock<a href="#reentrantreadwritelock" class="hash-link" aria-label="Direct link to ReentrantReadWriteLock" title="Direct link to ReentrantReadWriteLock">​</a></h3>
<p>ReadWriteLock 接口表示存在两个锁：一个读取 锁和一个写入锁，但在基于 AQS 实现ReentrantReadWriteLock 中，单个 AQS子类将同时管理读取加锁如写入加锁。 ReentrantReadWriteLock 使用了一个 16 位的状态来表示在写入锁的计数，并且使用了另…个 16 位的状态来表示读取锁的计数。在读取锁上的操作将使用共享的获取方法与释放方法，在写入锁上的操作将使用独占的获取方法与释放方法。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/java">Java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/concurrency">concurrency</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/java-concurrency-in-practice/14.构建自定义的同步工具.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/java-concurrency-in-practice/显示锁"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第13章 显示锁</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/java-concurrency-in-practice/原子变量与非阻塞同步机制"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第15章 原子变量与非阻塞同步机制</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#状态依赖性的管理" class="table-of-contents__link toc-highlight">状态依赖性的管理</a><ul><li><a href="#示例将前提条件的失败传递给调用者" class="table-of-contents__link toc-highlight">示例：将前提条件的失败传递给调用者</a></li><li><a href="#示例通过轮询与休眠来实现简单的阻塞" class="table-of-contents__link toc-highlight">示例：通过轮询与休眠来实现简单的阻塞</a></li><li><a href="#条件队列" class="table-of-contents__link toc-highlight">条件队列</a></li></ul></li><li><a href="#使用条件队列" class="table-of-contents__link toc-highlight">使用条件队列</a><ul><li><a href="#条件谓词" class="table-of-contents__link toc-highlight">条件谓词</a></li><li><a href="#过早唤醒" class="table-of-contents__link toc-highlight">过早唤醒</a></li><li><a href="#丢失的信号" class="table-of-contents__link toc-highlight">丢失的信号</a></li><li><a href="#通知" class="table-of-contents__link toc-highlight">通知</a></li><li><a href="#示例阀门类" class="table-of-contents__link toc-highlight">示例：阀门类</a></li><li><a href="#子类的安全问题" class="table-of-contents__link toc-highlight">子类的安全问题</a></li><li><a href="#封装条件队列" class="table-of-contents__link toc-highlight">封装条件队列</a></li><li><a href="#入口协议与出口协议" class="table-of-contents__link toc-highlight">入口协议与出口协议</a></li></ul></li><li><a href="#显式的condition对象" class="table-of-contents__link toc-highlight">显式的Condition对象</a></li><li><a href="#synchronized剖析" class="table-of-contents__link toc-highlight">Synchronized剖析</a></li><li><a href="#abstractqueuedsynchronizer" class="table-of-contents__link toc-highlight">AbstractQueuedSynchronizer</a></li><li><a href="#javauntilconcurrent同步器类中的aqs" class="table-of-contents__link toc-highlight">java.until.concurrent同步器类中的AQS</a><ul><li><a href="#reentrantlock" class="table-of-contents__link toc-highlight">ReentrantLock</a></li><li><a href="#semaphore与countdownlatch" class="table-of-contents__link toc-highlight">Semaphore与CountDownLatch</a></li><li><a href="#futuretask" class="table-of-contents__link toc-highlight">FutureTask</a></li><li><a href="#reentrantreadwritelock" class="table-of-contents__link toc-highlight">ReentrantReadWriteLock</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>