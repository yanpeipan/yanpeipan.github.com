<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-java-concurrency-in-practice/对象的组合" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">第4章 对象的组合 | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://yanpeipan.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://yanpeipan.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的组合"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第4章 对象的组合 | My Site"><meta data-rh="true" name="description" content="4. 对象的组合"><meta data-rh="true" property="og:description" content="4. 对象的组合"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的组合"><link data-rh="true" rel="alternate" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的组合" hreflang="en"><link data-rh="true" rel="alternate" href="https://yanpeipan.github.io/docs/java-concurrency-in-practice/对象的组合" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.16c07b82.css">
<script src="/assets/js/runtime~main.871c6c1d.js" defer="defer"></script>
<script src="/assets/js/main.30b99d3e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="织码如诗" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="织码如诗" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">织码如诗</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/intro">Java基础</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/java-concurrency-in-practice/简介">Java并发编程</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">数据库</a><ul class="dropdown__menu"><li>MySQL</li><li><a class="dropdown__link" href="/docs/mysql/2023">MySQL</a></li><li><a class="dropdown__link" href="/docs/redis/概述">Redis</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/简介">第1章 简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/线程安全性">第2章 线程安全性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/对象的共享">第3章 对象的共享</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/java-concurrency-in-practice/对象的组合">第4章 对象的组合</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/基础构建模块">第5章 基础构建模块</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/任务执行">第6章 任务执行</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/取消与关闭">第7章 取消与关闭</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/线程池的使用">第8章 线程池的使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/避免活跃性危险">第10章 避免活跃性危险</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/性能与可伸缩性">第11章 性能与可伸缩性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/并发程序的测试">第12章 并发程序的测试</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/显示锁">第13章 显示锁</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/构建自定义的同步工具">第14章 构建自定义的同步工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/原子变量与非阻塞同步机制">第15章 原子变量与非  阻塞同步机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java-concurrency-in-practice/Java内存模型">第16章 Java内存模型</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第4章 对象的组合</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>第4章 对象的组合</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-对象的组合">4. 对象的组合<a href="#4-对象的组合" class="hash-link" aria-label="Direct link to 4. 对象的组合" title="Direct link to 4. 对象的组合">​</a></h2>
<p>将一些现有的线程安全组件组合为更大规模的组件或程序</p>
<p>【先验条件】(precondition)
针对方法（method），它规定了在调用该方法之前必须为真的条件。</p>
<p>【后验条件】(postcondition)
也是针对方法，它规定了方法顺  利执行完毕之后必须为真的条件。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-设计线程安全的类">4.1 设计线程安全的类<a href="#41-设计线程安全的类" class="hash-link" aria-label="Direct link to 4.1 设计线程安全的类" title="Direct link to 4.1 设计线程安全的类">​</a></h3>
<p>基本要素：</p>
<ul>
<li>找出构成对象状态的所有变量</li>
<li>找出约束状态变量的不变性条件</li>
<li>建立对象状态的并发访问管理策略</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class Counter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;) private long value = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized long getValue() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized long increment() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (value == Long.MAX_VALUE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalStateException(&quot;counter overflow&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 后验条件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ++value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同步策略（Synchronization Policy)定义了如何在不违背对象不变条件或后验条件的情况下对其状态的访问操作进行协同。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="411-收集同步需求">4.1.1 收集同步需求<a href="#411-收集同步需求" class="hash-link" aria-label="Direct link to 4.1.1 收集同步需求" title="Direct link to 4.1.1 收集同步需求">​</a></h4>
<p>对状态进行推断，确保不变条件不会在并发访问的情况下被破坏。对象与变量都有一个状态空间，即所有可能的取值。状态空间越小，越容易判断线程的状态。final类型的域使用的越多，越能简化对象可能状态的分析过程。</p>
<p>操作中包含一些后验条件来判断状态迁移是否有效的，当下一个状态需要依赖当前状态时，这个操作必须是一个复合操作。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="412-依赖状态的操作">4.1.2 依赖状态的操作<a href="#412-依赖状态的操作" class="hash-link" aria-label="Direct link to 4.1.2 依赖状态的操作" title="Direct link to 4.1.2 依赖状态的操作">​</a></h4>
<p>类的不变条件与后验条件约束了在对象上有那些状态和状态转换时有效的。先验条件，移除队列一个元素前，队列处于非空状态。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="413-状态的所有权">4.1.3 状态的所有权<a href="#413-状态的所有权" class="hash-link" aria-label="Direct link to 4.1.3 状态的所有权" title="Direct link to 4.1.3 状态的所有权">​</a></h4>
<p>如果以某个对象为根节点构造一张对象图，那么该对象的状态将是对象图中所有对象包含的域的一个子集。</p>
<p>垃圾回收机制避免了如何处理所有权的问题。</p>
<p>容器类（Servlet）通常表现出一种“所有权分离”的形式，其中容器类拥有其自身的状态，而客户代码则有容器中各个对象的状态。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-实例封闭">4.2 实例封闭<a href="#42-实例封闭" class="hash-link" aria-label="Direct link to 4.2 实例封闭" title="Direct link to 4.2 实例封闭">​</a></h3>
<p>某对象不是线程安全的，那么可以通过多种技术使其在多线程程序中安全的使用。</p>
<p>封装简化了线程安全类的实现过程，它提供一种实例封闭机制（Instance Confinement），简称为封闭。封闭机制与合适的加锁策略结合起来，可以确保线程安全的方式使用非线程安全对象。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PersonSet {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Set&lt;Person&gt; mySet = new HashSet&lt;Person&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void addPerson(Person p) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mySet.add(p);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized boolean containsPerson(Person p) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return mySet.contains(p);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>封闭机制更易于构造线程安全的类，因为当时封闭类的状态时，在分析类的线程安全性时就无须检查整个程序</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="421-java监视器模式">4.2.1 Java监视器模式<a href="#421-java监视器模式" class="hash-link" aria-label="Direct link to 4.2.1 Java监视器模式" title="Direct link to 4.2.1 Java监视器模式">​</a></h4>
<p>从线程封闭原则及其逻辑推论可以得出Java监视器模式。遵循Java监视器模式的对象会把对象的所有可变状态都封装起来，并由对象自己的内置锁来保护。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class PrivateLock {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Object myLock = new Object();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;myLock&quot;) Widget widget;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void someMethod() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (myLock) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="422-示例车辆追踪">4.2.2 示例：车辆追踪<a href="#422-示例车辆追踪" class="hash-link" aria-label="Direct link to 4.2.2 示例：车辆追踪" title="Direct link to 4.2.2 示例：车辆追踪">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MonitorVehicleTracker {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GuardedBy(&quot;this&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, MutablePoint&gt; locations;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MonitorVehicleTracker() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-线程安全性的委托">4.3 线程安全性的委托<a href="#43-线程安全性的委托" class="hash-link" aria-label="Direct link to 4.3 线程安全性的委托" title="Direct link to 4.3 线程安全性的委托">​</a></h3>
<p>当从头开始构建一个类，或者将多个非线程安全的类组合成为一个类时，Java监视器模式时非常有用的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="431-示例基于委托的车辆追踪器">4.3.1 示例：基于委托的车辆追踪器<a href="#431-示例基于委托的车辆追踪器" class="hash-link" aria-label="Direct link to 4.3.1 示例：基于委托的车辆追踪器" title="Direct link to 4.3.1 示例：基于委托的车辆追踪器">​</a></h4>
<p>将线程安全委托给ConcurrentHashMap</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Immutable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Point {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final int x, y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Point(int x, int y) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.x = x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.y = y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DelegatingVehicleTracker {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConcurrentMap&lt;String, Point&gt; locations;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, Point&gt; unmodifiableMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DelegatingVehicleTracker(Map&lt;String, Point&gt; points) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        locations = new ConcurrentHashMap&lt;String, Point&gt;(points);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unmodifiableMap = Collections.unmodifiableMap(locations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Map&lt;String, Point&gt; getLocations() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return unmodifiableMap；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Point getLocation(Stirng id) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return locations.get(id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Map&lt;String, Point&gt; getLocations() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Collections.unmodifiableMap(new HashMap&lt;String, Point&gt;(locations));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setLocation(Stirng id, int x, int y) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (locations.replace(id, new Point(x, y)) == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(&quot;invalid vehicle name:&quot; + id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="432-独立的状态变量">4.3.2 独立的状态变量<a href="#432-独立的状态变量" class="hash-link" aria-label="Direct link to 4.3.2 独立的状态变量" title="Direct link to 4.3.2 独立的状态变量">​</a></h4>
<p>状态变量彼此独立，组合而成的类不会在其包含的多个状态变量上增加任何不变性条件</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class VisualComponent {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;KeyListener&gt; keyListeners = new CopyOnWriteArrayList&lt;KeyListener&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;MouseListener&gt; mouseListeners = new CopyOnWriteArrayList&lt;MouseListener&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void add(KeyListener listener) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keyListeners.add(listener);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void add(MouseListener listener) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mouseListeners.add(listener);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void remove(KeyListener listener) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keyListeners.remove(listener);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void remove(MouseListener listener) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mouseListeners.remove(listener);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="433-当委托失效">4.3.3 当委托失效<a href="#433-当委托失效" class="hash-link" aria-label="Direct link to 4.3.3 当委托失效" title="Direct link to 4.3.3 当委托失效">​</a></h4>
<p>NuberRange类不足以保护它的不变性条件，没有维持对下界和上界进行约束的不变性条件</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class NumberRange {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicInteger lower = new AtomicInteger(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicInteger upper = new AtomicInteger(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setLower(int i)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (i &gt; upper.get())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thron new IllegalArgumentException(&quot;can&#x27;t set lower to &quot; + i + &quot; &gt; upper&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        lower.set(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUpper(int i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (i &lt; lower.get())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(&quot;can&#x27;t set upper to &quot; + i + &quot; &lt; lower&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        upper.set(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public boolean isInRange(int i) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (i &gt;= lower.get() &amp;&amp; i &lt;= upper.get());`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="434-发布底层的状态变量">4.3.4 发布底层的状态变量<a href="#434-发布底层的状态变量" class="hash-link" aria-label="Direct link to 4.3.4 发布底层的状态变量" title="Direct link to 4.3.4 发布底层的状态变量">​</a></h4>
<p>如果一个状态变量是线程安全的，并且没有任何不变性条件来约束它的值，在变量的操作上也不存在不允许的状态转换，那么就可以安全的发布这个变量</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="435-示例发布状态的车辆追踪器">4.3.5 示例：发布状态的车辆追踪器<a href="#435-示例发布状态的车辆追踪器" class="hash-link" aria-label="Direct link to 4.3.5 示例：发布状态的车辆追踪器" title="Direct link to 4.3.5 示例：发布状态的车辆追踪器">​</a></h4>
<p>如果在车辆位置有效值上施加任何约束，如需要对车辆位置的变化进行判断或者当位置变化时执行一些操作，那么就不是线程安全的</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SafePoint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @guardedBy(&quot;this&quot;) private int x, y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SafePoint(SafePoint p) { this(p.get()); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SafePoint(int x, int y) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.x = x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.y = y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized int[] get() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new int[] {x, y};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void set(int x, int y) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.x = x;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.y = y;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PublishingVehicleTracker {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, SafePoint&gt; locations;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&lt;String, SafePoint&gt; unmodifiableMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PublishingVehicleTracker(Map&lt;String, SafePoint&gt; locations) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.locations = new ConcurrentHashMap&lt;String, SafePoint&gt;(locations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.unmodifiableMap = Collections.unmodifiableMap(this.locations);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Map&lt;String, SafePoint&gt; getLocations() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return unmodifiableMap；</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setLocation(String id, int x, int y) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!locations.containsKey(id))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException(&quot;invalid vehicle name: &quot; + id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        locations.get(id).set(x, y);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-在现有的线程安全类中添加功能">4.4 在现有的线程安全类中添加功能<a href="#44-在现有的线程安全类中添加功能" class="hash-link" aria-label="Direct link to 4.4 在现有的线程安全类中添加功能" title="Direct link to 4.4 在现有的线程安全类中添加功能">​</a></h3>
<p>重用能降低开发工作量、开发风险</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BetterVector&lt;E&gt; extends Vector&lt;E&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized boolean putIfAbsent(E x) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean absent = !contains(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (absent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            add(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return absent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>扩展方法比直接将代码添加到类中更加脆弱，因为现在的同步策略实现被分布到多个单独维护的源代码中</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="441-客户端加锁机制">4.4.1 客户端加锁机制<a href="#441-客户端加锁机制" class="hash-link" aria-label="Direct link to 4.4.1 客户端加锁机制" title="Direct link to 4.4.1 客户端加锁机制">​</a></h4>
<p>在错误的锁上进行了同步</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@NotThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ListHelper&lt;E&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;E&gt; list = Collections.synchronizedList(new ArrayList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized boolean putIfAbsent(E x) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean absent = !list.contains(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (absent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            list.add(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return absent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>客户端加锁（破坏同步策略的封装性）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ListHelper&lt;E&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public list&lt;E&gt; list = Collections.synchronizedList(new ArrayList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean putIfAbsent(E x) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        synchronized (list) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean absent = !list.contains(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (absent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                list.add(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return absent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="442-组合">4.4.2 组合<a href="#442-组合" class="hash-link" aria-label="Direct link to 4.4.2 组合" title="Direct link to 4.4.2 组合">​</a></h4>
<p>组合（Composition）</p>
<p>假设传递给构造函数后，客户代码不会再直接使用这个对象</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@ThreadSafe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ImprovedList&lt;T&gt; implements List&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final List&lt;T&gt; list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ImprovedList(List&lt;T&gt; list) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.list = list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized boolean putIfabsent(T x) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean contains = list.contains(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (contains) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            list.add(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return !contains;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public synchronized void clear() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        list.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="45-将同步策略文档化">4.5 将同步策略文档化<a href="#45-将同步策略文档化" class="hash-link" aria-label="Direct link to 4.5 将同步策略文档化" title="Direct link to 4.5 将同步策略文档化">​</a></h3>
<p>在文档中说明客户代码需要了解的线程安全性保证，以及代码维护人员需要了解的同步策略。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/java">Java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/concurrency">concurrency</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/java-concurrency-in-practice/04-对象的组合.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/java-concurrency-in-practice/对象的共享"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">第3章 对象的共享</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/java-concurrency-in-practice/基础构建模块"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">第5章 基础构建模块</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#4-对象的组合" class="table-of-contents__link toc-highlight">4. 对象的组合</a><ul><li><a href="#41-设计线程安全的类" class="table-of-contents__link toc-highlight">4.1 设计线程安全的类</a></li><li><a href="#42-实例封闭" class="table-of-contents__link toc-highlight">4.2 实例封闭</a></li><li><a href="#43-线程安全性的委托" class="table-of-contents__link toc-highlight">4.3 线程安全性的委托</a></li><li><a href="#44-在现有的线程安全类中添加功能" class="table-of-contents__link toc-highlight">4.4 在现有的线程安全类中添加功能</a></li><li><a href="#45-将同步策略文档化" class="table-of-contents__link toc-highlight">4.5 将同步策略文档化</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>